let ws;
const JETSON_IP = '172.20.10.3';
const WS_PORT   = '3000';

function logInfo(msg) {
  const ul = document.getElementById('info_log');
  if (!ul) return;
  const li = document.createElement('li');
  li.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  ul.prepend(li);                       
  while (ul.children.length > 80) ul.removeChild(ul.lastChild);
}

let lastTakeOffStatus = null;
let lastLandingStatus = null;
let landing_height = false;

function connectWebSocket() {
  ws = new WebSocket(`ws://${JETSON_IP}:${WS_PORT}`);

  ws.onopen = () => {
    logInfo('‚úÖ WebSocket Ïó∞Í≤∞Îê®');
  };

  ws.onclose = () => {
    logInfo('‚ö†Ô∏è WebSocket ÎÅäÍπÄ. 5Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ');
    setTimeout(connectWebSocket, 5000);
  };

  ws.onerror = (error) => {
    logInfo('üö® WebSocket Ïò§Î•ò Î∞úÏÉù');
  };

  ws.onmessage = (event) => {
    try {
      const payload = JSON.parse(event.data);
      const items = Array.isArray(payload) ? payload : [payload];
      for (const data of items) {
        handleMessage(data);
      }
    } catch (e) {
      logInfo('ÌååÏã±Ïò§Î•ò');
    }
  };
}

function handleMessage(data) {
  if (data.topic === 'sky_camera/image_raw' && data.type === 'image' && data.data) {
    const imgElement = document.getElementById('camera');
    if (imgElement) {
      imgElement.src = 'data:image/jpeg;base64,' + data.data;
    }
  }

  else if (data.topic === 'front_camera/image_raw' && data.type === 'image' && data.data) {
    const imgElement = document.getElementById('camera');
    if (imgElement) {
      imgElement.src = 'data:image/jpeg;base64,' + data.data;
    }
  }
  
  if (data.topic === 'dist_to_target' && data.type === 'Float'){
    const dist = parseFloat(data.data).toFixed(3);
    document.getElementById('follow-distance').textContent = dist + ' m';
  }

  if (data.topic === 'reached' && data.type === 'Bool'){
    if (data.data === true) {
      document.getElementById('follow-state').textContent = 'üü¢ Ï∂îÏ¢ÖÏ§ë...';
      landing_height = true;
    } else {
      document.getElementById('follow-state').textContent = 'üî¥ ÎåÄÍ∏∞';
      landing_height = false;
      document.getElementById('drone-height').textContent = '-';

    }
  }

  if (data.topic === 'kill' && data.type === 'Bool'){
    if (data.data === true) {
      document.getElementById('person-detected').textContent = 'üî¥ ÏúÑÌóò Í∞êÏßÄ';
      document.getElementById('internal-temp').textContent = 'Human';
    } else {
      document.getElementById('person-detected').textContent = 'üü¢ Ï†ïÏÉÅ';
      document.getElementById('internal-temp').textContent = 'ÏóÜÏùå';
    } 
  }

if (data.topic === 'md/rpm_left' && data.type === 'Float') {
  document.getElementById('rpm_left').textContent = data.data;

  const fakeCurrent = (data.data * 0.005 + Math.random() * 0.05).toFixed(3); 
  document.getElementById('current_left').textContent = fakeCurrent;
}

if (data.topic === 'md/rpm_right' && data.type === 'Float') {
  document.getElementById('rpm_right').textContent = data.data;

  const fakeCurrent = (data.data * 0.005 + Math.random() * 0.05).toFixed(3);
  document.getElementById('current_right').textContent = fakeCurrent;
}


  if (data.topic === 'md/state_left' && data.type === 'UInt'){
      console.log(data.data);

    switch (data.data) {
      case 0: document.getElementById('state_left').textContent = 'üü¢ Ï†ïÏÉÅ / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 1: document.getElementById('state_left').textContent = 'üî¥ CTRL_FAIL / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 2: document.getElementById('state_left').textContent = 'üî¥ OVER_VOLT / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 3: document.getElementById('state_left').textContent = 'üî¥ OVER_TEMP / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 4: document.getElementById('state_left').textContent = 'üî¥ OVER_LOAD / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 5: document.getElementById('state_left').textContent = 'üî¥ HALL_FAIL or ENC_FAIL / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 6: document.getElementById('state_left').textContent = 'üî¥ INV_VEL / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 7: document.getElementById('state_left').textContent = 'üî¥ STALL / ÏÉÅÌÉú Bit : ' + data.data; break;
    }
  }

  if (data.topic === 'md/state_right' && data.type === 'UInt'){
    switch (data.data) {
      case 0: document.getElementById('state_right').textContent = 'üü¢ Ï†ïÏÉÅ / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 1: document.getElementById('state_right').textContent = 'üî¥ CTRL_FAIL / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 2: document.getElementById('state_right').textContent = 'üî¥ OVER_VOLT / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 3: document.getElementById('state_right').textContent = 'üî¥ OVER_TEMP / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 4: document.getElementById('state_right').textContent = 'üî¥ OVER_LOAD / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 5: document.getElementById('state_right').textContent = 'üî¥ HALL_FAIL or ENC_FAIL / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 6: document.getElementById('state_right').textContent = 'üî¥ INV_VEL / ÏÉÅÌÉú Bit : ' + data.data; break;
      case 7: document.getElementById('state_right').textContent = 'üî¥ STALL / ÏÉÅÌÉú Bit : ' + data.data; break;
    }
  }

  if (data.topic === 'take_off_status' && data.type === 'Int' && data.data !== lastTakeOffStatus) {
    lastTakeOffStatus = data.data;
    console.log("info Î©îÏãúÏßÄ Î∞õÏïÑÏò¥");
    switch (data.data) {
      case 1: logInfo('üìç "Í≤©ÎÇ©Í≥†" ‚û°Ô∏è "ÏäπÌïòÏ∞®Ïû•" ÏúºÎ°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§'); break;
      case 2: logInfo('üìç ÏäπÍ∞ù ÌÉëÏäπ ÎåÄÍ∏∞Ï§ëÏûÖÎãàÎã§.'); break;
      case 3: 
        logInfo('‚úÖ ÏäπÍ∞ù ÌÉëÏäπ ÏôÑÎ£å.');
        logInfo('üìç "ÏäπÌïòÏ∞®Ïû•" ‚û°Ô∏è "Ïù¥Ï∞©Î•ôÏû•" ÏúºÎ°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§.'); break;
      case 4: logInfo('üöÅ ÎìúÎ°† Ïù¥Î•ô : Ïù¥Î•ôÏùÑ ÏãúÏûëÌï©ÎãàÎã§.');break;
      case 5: 
        logInfo('‚úÖ ÎìúÎ°† Ïù¥Î•ô ÏôÑÎ£å.');
        logInfo('üìç "Ïù¥Ï∞©Î•ôÏû•" ‚û°Ô∏è "Í≤©ÎÇ©Í≥†" Î°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§.'); break;
      case 6: logInfo('‚úÖ Îã§Ïùå Î™ÖÎ†πÏùÑ ÎåÄÍ∏∞Ìï©ÎãàÎã§.'); break;
    }
  }

  if (data.topic === 'landing_status' && data.type === 'Int' && data.data !== lastLandingStatus) {
    lastLandingStatus = data.data;
    switch (data.data) {
      case 1: logInfo('üìç "Í≤©ÎÇ©Í≥†" ‚û°Ô∏è "Ïù¥Ï∞©Î•ôÏû•" ÏúºÎ°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§'); break;
      case 2: logInfo('üõ¨ ÎìúÎ°† Ï∂îÏ¢Ö : Ï∞©Î•ôÏùÑ ÏãúÏûëÌï©ÎãàÎã§.');break;
      case 3: 
        logInfo('‚úÖ ÎìúÎ°† Ï∞©Î•ô ÏôÑÎ£å.');          
        logInfo('üìç "Ïù¥Ï∞©Î•ôÏû•" ‚û°Ô∏è "ÏäπÌïòÏ∞®Ïû•" ÏúºÎ°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§.'); break;
      case 4:
        logInfo('üìç ÏäπÍ∞ù ÌïòÏ∞® Ï§ë...'); break;        
      case 5:
        logInfo('‚úÖ ÏäπÍ∞ù ÌïòÏ∞® ÏôÑÎ£å.');          
        logInfo('üîã Í∏∞Ï≤¥ Î∞∞ÌÑ∞Î¶¨ Ï∂©Î∂Ñ.');
        logInfo('üìç "ÏäπÌïòÏ∞®Ïû•" ‚û°Ô∏è "Í≤©ÎÇ©Í≥†" Î°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§.');
        break;
      case 6:
        logInfo('‚úÖ ÏäπÍ∞ù ÌïòÏ∞® ÏôÑÎ£å.');          
        logInfo('‚ö° Í∏∞Ï≤¥ Î∞∞ÌÑ∞Î¶¨ Î∂ÄÏ°±.');
        logInfo('üìç "ÏäπÌïòÏ∞®Ïû•" ‚û°Ô∏è "Ï∂©Ï†ÑÏÜå" Î°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§.');
        break;
      case 7:
        logInfo('üîã Í∏∞Ï≤¥ Î∞∞ÌÑ∞Î¶¨ Ï∂©Ï†Ñ ÏãúÏûë.');
        let sec = 1;
              const chargingTimer = setInterval(() => {
                if (sec <= 5) {
                  logInfo(`üîã Ï∂©Ï†ÑÏ§ë... (${sec}Ï¥à Í≤ΩÍ≥º)`);
                  sec++;
                } 
                if (sec > 5) {
                  clearInterval(chargingTimer);
                }
              }, 1000);
        break;
      case 8:
        setTimeout(() => {
          logInfo('üîã Í∏∞Ï≤¥ Î∞∞ÌÑ∞Î¶¨ Ï∂©Ï†Ñ ÏôÑÎ£å.');
          logInfo('üìç "Ï∂©Ï†ÑÏÜå" ‚û°Ô∏è "Í≤©ÎÇ©Í≥†" Î°ú Ïù¥Îèô Ï§ëÏûÖÎãàÎã§.');
        }, 1000);
        break;
      case 9:
        logInfo('‚úÖ Îã§Ïùå Î™ÖÎ†πÏùÑ ÎåÄÍ∏∞Ìï©ÎãàÎã§.');
        break;
    }
  }
}

window.addEventListener('DOMContentLoaded', () => {
  connectWebSocket();
});

const socket = io('http://localhost:5000');

socket.on('sensor_update', data => {
  const sensor = data.sensor;
  if (!sensor) return;

  document.getElementById('bat').textContent    = sensor.bat ?? '-';
  document.getElementById('roll').textContent   = sensor.roll ?? '-';
  document.getElementById('pitch').textContent  = sensor.pitch ?? '-';
  document.getElementById('height').textContent = sensor.height ?? '-';

  if (landing_height == true){
    document.getElementById('drone-height').textContent = sensor.height;
  }

  if (ws && ws.readyState === WebSocket.OPEN) {
    const payload = {
      topic: 'sensor',
      type:  'info',
      bat:   sensor.bat,
      height: sensor.height
    };
    ws.send(JSON.stringify(payload));
  }
});


const BTN = {
  standby:   document.getElementById('btn-standby'),  
  follow:    document.getElementById('btn-follow'),    
  emergency: document.getElementById('btn-emergency'),
};

const hasBtns = BTN.standby && BTN.follow && BTN.emergency;

function setBtnDisabled(el, disabled) {
  if (!el) return;
  if (disabled) el.setAttribute('disabled', 'true');
  else el.removeAttribute('disabled');
}

const TOPIC = {
  TAKEOFF: 'take_off_scenario', 
  LANDING: 'landing_scenario',  
};
const ACTION = { TAKEOFF: 'TAKEOFF', LANDING: 'LANDING' };
let standbyAction = ACTION.TAKEOFF;

const FOLLOW = {IN: 'IN', OUT: 'OUT'};
let followAction = FOLLOW.IN

const EMERGENCY = {EMERGENCY: 'EMERGENCY', RESTART: 'RESTART' };
let emergencyAction = EMERGENCY.EMERGENCY;

function setStandbyAction(action) {
  standbyAction = action;
  if (!BTN.standby) return;
  BTN.standby.textContent = (action === ACTION.TAKEOFF) ? 'Ïù¥Î•ô ÏäπÏù∏' : 'Ï∞©Î•ô ÏäπÏù∏';
}

function setFollowAction(action){
  followAction = action;
  if (!BTN.follow) return;
  BTN.follow.textContent = (action === FOLLOW.IN) ? 'ÏäπÍ∞ù ÌÉëÏäπ ÏôÑÎ£å' : 'ÏäπÍ∞ù ÌïòÏ∞® ÏôÑÎ£å';
}

function setEmergencyAction(action) {
  emergencyAction = action;
  if (!BTN.emergency) return;
  BTN.emergency.textContent = (action === EMERGENCY.EMERGENCY) ? 'ÎπÑÏÉÅ Ï†ïÏßÄ' : 'Ïö¥Ìñâ Ïû¨Í∞ú';
}

function applyDefaultButtons() {
  setStandbyAction(ACTION.TAKEOFF);
  setBtnDisabled(BTN.standby, false);
  setBtnDisabled(BTN.follow,  true);
  setBtnDisabled(BTN.emergency, false);
}

function updateButtonsFromStatus() {
  if (!hasBtns) return;

  let standbyDisabled = false;
  let followDisabled  = true;
  let emergencyDisabled = false;

  if (lastTakeOffStatus != null) {
    switch (lastTakeOffStatus) {
      case 1:
        standbyDisabled = true;
        followDisabled = true;
        break;
      case 2: 
        standbyDisabled = true;
        followDisabled = false;
        break;
      case 3:
        standbyDisabled = true;
        followDisabled = true;
        break;
      case 4:
        standbyDisabled = true;
        followDisabled = true;
        break;
      case 5:
        standbyDisabled = true;
        followDisabled = true;
        break;        
      case 6:
        setStandbyAction(ACTION.LANDING);
        setFollowAction(FOLLOW.OUT);
        standbyDisabled = false;
        followDisabled  = true;
        break;
      default: 
        break;
    }
  }

  if (lastLandingStatus != null) {
    switch (lastLandingStatus) {
      case 1:
        standbyDisabled = true;
        followDisabled = true;
        break;     
      case 2:
        standbyDisabled = true;
        followDisabled = true;
        break; 
      case 3:
        standbyDisabled = true;
        followDisabled = true;
        break; 
      case 4:
        standbyDisabled = true;
        followDisabled = false;
        break; 
      case 5:
        standbyDisabled = true;
        followDisabled = true;
        break; 
      case 6:
        standbyDisabled = true;
        followDisabled = true;
        break;
      case 7:
        standbyDisabled = true;
        followDisabled = true;
        break;
      case 8:
        standbyDisabled = true;
        followDisabled = true;
        break;  
      case 9:
        setStandbyAction(ACTION.TAKEOFF);
        setFollowAction(FOLLOW.IN);
        standbyDisabled = false;
        followDisabled  = true;
        break;
      default:
        break;
    }
  }

  setBtnDisabled(BTN.standby,  standbyDisabled);
  setBtnDisabled(BTN.follow,   followDisabled);
  setBtnDisabled(BTN.emergency, emergencyDisabled);
}

if (hasBtns) applyDefaultButtons();

(function hookStatusToButtons() {
  setInterval(updateButtonsFromStatus, 300);
})();


function publishViaWS(payload) {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    logInfo('‚ö†Ô∏è WebSocket ÎØ∏Ïó∞Í≤∞: Î™ÖÎ†π Ï†ÑÏÜ° Ïã§Ìå®');
    return;
  }
  ws.send(JSON.stringify(payload));
}

if (hasBtns) {
  BTN.standby.addEventListener('click', () => {
    if (BTN.standby.hasAttribute('disabled')) return;

    if (standbyAction === ACTION.TAKEOFF) {
      logInfo('‚úÖ Ïù¥Î•ô ÏöîÏ≤≠ ÏäπÏù∏');
      publishViaWS({topic : TOPIC.TAKEOFF, type : 'command', data : true});
      setBtnDisabled(BTN.standby, true);
    } 
    else {
      logInfo('‚úÖ Ï∞©Î•ô ÏöîÏ≤≠ ÏäπÏù∏');
      publishViaWS({topic : TOPIC.LANDING, type : 'command', data : true});
      setBtnDisabled(BTN.standby, true);
    }
  });

  BTN.follow.addEventListener('click', () => {
    publishViaWS({ topic : 'start_check', type : 'command', data : true});
    setBtnDisabled(BTN.follow, true);
    publishViaWS({ topic : 'start_check', type : 'command', data : false});
  });

  BTN.emergency.addEventListener('click', () => {
    if (emergencyAction === EMERGENCY.EMERGENCY){
      logInfo('üõë ÎπÑÏÉÅ Ï†ïÏßÄ ÏöîÏ≤≠');
      publishViaWS({ topic : 'emergency_stop', type: 'command', data: true});
      setEmergencyAction(EMERGENCY.RESTART);
    }
    else{
      logInfo('üü¢ Ïö¥Ìñâ Ïû¨Í∞ú ÏöîÏ≤≠');
      publishViaWS({ topic : 'emergency_stop', type: 'command', data: false});
      setEmergencyAction(EMERGENCY.EMERGENCY);
    }
  });
}
